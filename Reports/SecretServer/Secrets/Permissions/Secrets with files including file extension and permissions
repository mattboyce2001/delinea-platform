SELECT
fo.FolderPath,
s.SecretName,
i.FileAttachmentId,
f.FileName,
RIGHT(LOWER(f.FileName), CHARINDEX('.', REVERSE(LOWER(f.FileName)) + '.') - 1) AS FileExtension,
IIF(d2.[Domain] IS NULL, IIF(g.[IsPersonal] = 1, u.[DisplayName], g.[GroupName]), d2.[Domain] + N'\' + IIF(g.[IsPersonal] = 1, u.[DisplayName], g.[GroupName])) AS [Username/Group],
CASE (acl.[Permissions])
WHEN 1 THEN 'List'
WHEN 1 | 2 THEN 'List/View'
WHEN 1 | 2 | 4 THEN 'List/View/Edit'
WHEN 1 | 2 | 4 | 8 THEN 'List/View/Edit/Owner'
END AS [Permissions],
CASE
WHEN fo.[EnableInheritPermissions] = 1 THEN 'A Parent Folder'
ELSE 'Folder'
END AS [Permissions On]
FROM tbSecret AS s
INNER JOIN tbSecretItem AS i ON i.SecretID = s.SecretID
INNER JOIN tbFileAttachment f ON i.FileAttachmentId = f.FileAttachmentId
INNER JOIN tbFolder fo ON fo.FolderID = s.FolderId
INNER JOIN dbo.tbSecretACL acl ON s.SecretID = acl.SecretID
INNER JOIN dbo.tbGroup g ON acl.[GroupID] = g.[GroupID]
INNER JOIN dbo.tbUserGroup ug ON acl.[GroupID] = ug.[GroupID]
INNER JOIN dbo.tbUser u ON ug.[UserID] = u.[UserId]
LEFT JOIN dbo.tbDomain d2 ON g.[DomainId] = d2.[DomainId]
WHERE i.FileAttachmentId IS NOT NULL
AND s.Active = 1
AND f.FileName LIKE '%.%'
ORDER BY FileExtension
