SELECT
u.[DisplayName] AS [Username],
ISNULL(f.FolderPath, 'No Folder assigned') AS [FolderPath],
s.[SecretName] AS [SecretName],
st.[SecretTypeName] AS [SecretTemplate],
CASE acl.[Permissions]
WHEN 1 THEN 'List'
WHEN 3 THEN 'List/View'
WHEN 7 THEN 'List/View/Edit'
WHEN 15 THEN 'List/View/Edit/Owner'
END AS [Permissions],
IIF(d2.[Domain] IS NULL, u.[DisplayName], d2.[Domain] + N'\' + u.[DisplayName]) AS [Username/Group],
CASE s.[EnableInheritPermissions]
WHEN 0 THEN 'Secret'
WHEN 1 THEN IIF(f.[EnableInheritPermissions] = 1, 'A Parent Folder', 'Folder')
END AS [Permissions On],
s.[SecretId]
FROM dbo.tbSecret s WITH (NOLOCK)
JOIN dbo.tbSecretType st WITH (NOLOCK) ON s.[SecretTypeID] = st.[SecretTypeID] AND s.[Active] = 1
LEFT JOIN dbo.tbFolder f WITH (NOLOCK) ON s.[FolderID] = f.[FolderId]
JOIN dbo.tbSecretACL acl WITH (NOLOCK) ON s.SecretID = acl.SecretID
JOIN dbo.tbUserGroup ug WITH (NOLOCK) ON acl.[GroupID] = ug.[GroupID]
JOIN dbo.tbUser u WITH (NOLOCK) ON ug.[UserID] = u.[UserId]
LEFT JOIN dbo.tbDomain d2 WITH (NOLOCK) ON u.[DomainId] = d2.[DomainId]
WHERE s.[FolderID] is null
ORDER BY s.[SecretId]
